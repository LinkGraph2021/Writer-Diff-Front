<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>HTML Diff Tool</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; }
    .diff-output { display: flex; gap: 20px; }
    .diff-column { width: 50%; background: #f4f4f4; padding: 1em; border-radius: 5px; }
    h1, h2, h3, h4, h5, h6, p {
      margin-top: 1em;
    }
    .inserted {
      background: #a6f3a6;
    }
    .deleted {
      background: #f3a6a6;
      text-decoration: line-through;
    }
  </style>
</head>
<body>
  <h1>Compare Headings and Paragraphs</h1>
  <form id="compareForm">
    <label>URL 1: <input type="url" id="url1" required></label>
    <label>Selector 1 (optional): <input type="text" id="selector1"></label><br>

    <label>URL 2: <input type="url" id="url2" required></label>
    <label>Selector 2 (optional): <input type="text" id="selector2"></label><br>

    <button type="submit">Compare</button>
  </form>

  <h2>Diff Output</h2>
  <div id="output" class="diff-output">
    <div id="output1" class="diff-column"></div>
    <div id="output2" class="diff-column"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <script>
    function renderContent(node) {
      if (!node) return '';
      if (['h1','h2','h3','h4','h5','h6','p'].includes(node.type)) {
        const tag = node.type;
        const children = node.children.map(renderContent).join('');
        return `<${tag}>${node.content}</${tag}>${children}`;
      } else if (node.children) {
        return node.children.map(renderContent).join('');
      }
      return '';
    }

    function renderDiffs(nodes1, nodes2, dmp) {
      const maxLength = Math.max(nodes1.length, nodes2.length);
      const output1 = [];
      const output2 = [];

      for (let i = 0; i < maxLength; i++) {
        const node1 = nodes1[i];
        const node2 = nodes2[i];

        if (node1 && node2 && node1.type === node2.type) {
          const diffs = dmp.diff_main(node1.content, node2.content);
          dmp.diff_cleanupSemantic(diffs);

          const content1 = diffs.map(([op, data]) => {
            if (op === -1) return `<span class="deleted">${data}</span>`;
            if (op === 0) return `<span>${data}</span>`;
            return '';
          }).join('');

          const content2 = diffs.map(([op, data]) => {
            if (op === 1) return `<span class="inserted">${data}</span>`;
            if (op === 0) return `<span>${data}</span>`;
            return '';
          }).join('');

          output1.push(`<${node1.type}>${content1}</${node1.type}>`);
          output2.push(`<${node2.type}>${content2}</${node2.type}>`);

          if (node1.children && node2.children) {
            const childDiffs = renderDiffs(node1.children, node2.children, dmp);
            output1.push(childDiffs.output1);
            output2.push(childDiffs.output2);
          }
        } else {
          if (node1) {
            output1.push(`<${node1.type} class="deleted">${node1.content}</${node1.type}>`);
          }
          if (node2) {
            output2.push(`<${node2.type} class="inserted">${node2.content}</${node2.type}>`);
          }
        }
      }

      return { output1: output1.join(''), output2: output2.join('') };
    }

    document.getElementById('compareForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url1 = document.getElementById('url1').value;
      const url2 = document.getElementById('url2').value;
      const selector1 = document.getElementById('selector1').value;
      const selector2 = document.getElementById('selector2').value;

      try {
        const res = await fetch('https://writer-diff-back.onrender.com/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url1, url2, selector1, selector2 })
        });

        const result = await res.json();

        const dmp = new diff_match_patch();
        const diffs = renderDiffs(result.url1, result.url2, dmp);

        document.getElementById('output1').innerHTML = diffs.output1;
        document.getElementById('output2').innerHTML = diffs.output2;
      } catch (err) {
        document.getElementById('output1').innerHTML = 'Error fetching or processing data: ' + err.message;
        document.getElementById('output2').innerHTML = '';
        console.error(err);
      }
    });
  </script>
</body>
</html>
