<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>HTML Diff Tool</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input { width: 100%; margin-bottom: 10px; }
    .diff-output { white-space: pre-wrap; background: #f4f4f4; padding: 1em; border-radius: 5px; margin-top: 2em; }
    .column-wrapper { display: flex; gap: 20px; }
    .column { flex: 1; background: #fafafa; padding: 10px; border: 1px solid #ccc; overflow-y: auto; max-height: 400px; }
    .column h1, .column h2, .column h3, .column h4, .column h5, .column h6 { margin: 0.5em 0 0.2em; }
    .added { background: #a6f3a6; }
    .removed { background: #f3a6a6; text-decoration: line-through; }
  </style>
</head>
<body>
  <h1>Compare Headings and Paragraphs</h1>
  <form id="compareForm">
    <label>URL 1: <input type="url" id="url1" required></label>
    <label>Selector 1 (optional): <input type="text" id="selector1"></label><br>

    <label>URL 2: <input type="url" id="url2" required></label>
    <label>Selector 2 (optional): <input type="text" id="selector2"></label><br>

    <button type="submit">Compare</button>
  </form>

  <h2>Structured Crawl Output</h2>
  <div class="column-wrapper">
    <div class="column" id="structured1"></div>
    <div class="column" id="structured2"></div>
  </div>

  <h2>Diff Comparison</h2>
  <div id="output" class="diff-output"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
  <script>
    function renderStructuredContent(data, container) {
      function recurse(nodes, depth = 0) {
        return nodes.map(node => {
          if (node.type.startsWith('h')) {
            return `<${node.type}>${node.content}</${node.type}>`;
          }
          if (node.type === 'p') {
            return `<p>${node.content}</p>`;
          }
          if (node.children && node.children.length) {
            return recurse(node.children, depth + 1).join('\n');
          }
          return '';
        }).join('\n');
      }
      container.innerHTML = recurse(data);
    }

    function flattenContent(data) {
      let result = [];
      function recurse(nodes) {
        nodes.forEach(node => {
          if (node.type.startsWith('h')) {
            result.push(`<${node.type}>${node.content}</${node.type}>`);
          } else if (node.type === 'p') {
            result.push(`<p>${node.content}</p>`);
          }
          if (node.children && node.children.length) recurse(node.children);
        });
      }
      recurse(data);
      return result.join('\n');
    }

    document.getElementById('compareForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url1 = document.getElementById('url1').value;
      const url2 = document.getElementById('url2').value;
      const selector1 = document.getElementById('selector1').value;
      const selector2 = document.getElementById('selector2').value;

      try {
        const res = await fetch('https://writer-diff-back.onrender.com/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url1, url2, selector1, selector2 })
        });

        const result = await res.json();

        renderStructuredContent(result.url1, document.getElementById('structured1'));
        renderStructuredContent(result.url2, document.getElementById('structured2'));

        const content1 = flattenContent(result.url1);
        const content2 = flattenContent(result.url2);

        const dmp = new diff_match_patch();
        const diff = dmp.diff_main(content1, content2);
        dmp.diff_cleanupSemantic(diff);

        const output = diff.map(([op, data]) => {
          if (op === 1) return `<span class="added">${data}</span>`;
          if (op === -1) return `<span class="removed">${data}</span>`;
          return `<span>${data}</span>`;
        }).join('');

        document.getElementById('output').innerHTML = output;
      } catch (err) {
        document.getElementById('output').innerHTML = 'Error fetching or processing data: ' + err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
